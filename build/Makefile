# Beyond the Science of Reading - ç”µå­ä¹¦æž„å»º Makefile
# å‚è€ƒ xindoo/agentic-design-patterns é¡¹ç›®æž¶æž„

.PHONY: all pdf epub mobi clean setup install check-deps help

# é»˜è®¤ç›®æ ‡
all: pdf epub mobi

# è®¾ç½®å˜é‡
PROJECT_ROOT := $(shell pwd)/..
BUILD_DIR := $(PROJECT_ROOT)/build
DIST_DIR := $(PROJECT_ROOT)/dist
NODE_BIN := $(BUILD_DIR)/node_modules/.bin

# é¢œè‰²å®šä¹‰
RED := \033[31m
GREEN := \033[32m
YELLOW := \033[33m
BLUE := \033[34m
RESET := \033[0m

# å¸®åŠ©ä¿¡æ¯
help:
	@echo "$(BLUE)Beyond the Science of Reading - ç”µå­ä¹¦æž„å»ºç³»ç»Ÿ$(RESET)"
	@echo ""
	@echo "$(GREEN)å¯ç”¨å‘½ä»¤:$(RESET)"
	@echo "  $(YELLOW)make setup$(RESET)     - å®‰è£…ä¾èµ–å¹¶æ£€æŸ¥çŽ¯å¢ƒ"
	@echo "  $(YELLOW)make all$(RESET)       - æž„å»ºæ‰€æœ‰æ ¼å¼ (PDF + EPUB + MOBI)"
	@echo "  $(YELLOW)make pdf$(RESET)       - ä»…æž„å»º PDF"
	@echo "  $(YELLOW)make epub$(RESET)      - ä»…æž„å»º EPUB"
	@echo "  $(YELLOW)make mobi$(RESET)      - ä»…æž„å»º MOBI"
	@echo "  $(YELLOW)make clean$(RESET)     - æ¸…ç†æž„å»ºæ–‡ä»¶"
	@echo "  $(YELLOW)make check-deps$(RESET) - æ£€æŸ¥ç³»ç»Ÿä¾èµ–"
	@echo "  $(YELLOW)make help$(RESET)      - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"
	@echo ""
	@echo "$(GREEN)ç³»ç»Ÿè¦æ±‚:$(RESET)"
	@echo "  - Node.js >= 14.0.0"
	@echo "  - Pandoc (brew install pandoc)"
	@echo "  - Calibre (brew install --cask calibre) - å¯é€‰ï¼Œç”¨äºŽ MOBI"

# å®‰è£…å’Œè®¾ç½®
setup: install check-deps
	@echo "$(GREEN)âœ… çŽ¯å¢ƒè®¾ç½®å®Œæˆ$(RESET)"

install:
	@echo "$(BLUE)ðŸ“¦ å®‰è£… Node.js ä¾èµ–...$(RESET)"
	cd $(BUILD_DIR) && npm install

check-deps:
	@echo "$(BLUE)ðŸ” æ£€æŸ¥ç³»ç»Ÿä¾èµ–...$(RESET)"
	@command -v node >/dev/null 2>&1 || { echo "$(RED)âŒ Node.js æœªå®‰è£…$(RESET)"; exit 1; }
	@command -v pandoc >/dev/null 2>&1 || { echo "$(RED)âŒ Pandoc æœªå®‰è£…ï¼Œè¯·è¿è¡Œ: brew install pandoc$(RESET)"; exit 1; }
	@command -v ebook-convert >/dev/null 2>&1 || echo "$(YELLOW)âš ï¸  Calibre æœªå®‰è£…ï¼Œæ— æ³•ç”Ÿæˆ MOBI æ ¼å¼: brew install --cask calibre$(RESET)"
	@echo "$(GREEN)âœ… ä¾èµ–æ£€æŸ¥å®Œæˆ$(RESET)"

# æž„å»ºç›®æ ‡
pdf:
	@echo "$(BLUE)ðŸ“„ æž„å»º PDF ç”µå­ä¹¦...$(RESET)"
	cd $(BUILD_DIR) && node build-ebooks.js pdf
	@echo "$(GREEN)âœ… PDF æž„å»ºå®Œæˆ$(RESET)"

epub:
	@echo "$(BLUE)ðŸ“± æž„å»º EPUB ç”µå­ä¹¦...$(RESET)"
	cd $(BUILD_DIR) && node build-ebooks.js epub
	@echo "$(GREEN)âœ… EPUB æž„å»ºå®Œæˆ$(RESET)"

mobi:
	@echo "$(BLUE)ðŸ“– æž„å»º MOBI ç”µå­ä¹¦...$(RESET)"
	cd $(BUILD_DIR) && node build-ebooks.js mobi
	@echo "$(GREEN)âœ… MOBI æž„å»ºå®Œæˆ$(RESET)"

# æ¸…ç†
clean:
	@echo "$(BLUE)ðŸ§¹ æ¸…ç†æž„å»ºæ–‡ä»¶...$(RESET)"
	rm -rf $(BUILD_DIR)/temp
	rm -rf $(BUILD_DIR)/node_modules
	rm -rf $(DIST_DIR)
	@echo "$(GREEN)âœ… æ¸…ç†å®Œæˆ$(RESET)"

# å¿«é€Ÿæž„å»ºè„šæœ¬
quick-pdf:
	@echo "$(BLUE)âš¡ å¿«é€Ÿ PDF æž„å»ºï¼ˆä½¿ç”¨ Pandocï¼‰...$(RESET)"
	mkdir -p $(DIST_DIR)
	pandoc $(PROJECT_ROOT)/index.md $(PROJECT_ROOT)/chapters/*.md \
		-o $(DIST_DIR)/Beyond-the-Science-of-Reading-Quick.pdf \
		--pdf-engine=xelatex \
		--variable mainfont="PingFang SC" \
		--variable CJKmainfont="PingFang SC" \
		--toc \
		--number-sections
	@echo "$(GREEN)âœ… å¿«é€Ÿ PDF æž„å»ºå®Œæˆ$(RESET)"

# å¼€å‘æ¨¡å¼
dev: setup
	@echo "$(BLUE)ðŸš€ å¯åŠ¨å¼€å‘æ¨¡å¼...$(RESET)"
	cd $(BUILD_DIR) && npm run build

# å‘å¸ƒå‡†å¤‡
release: clean setup all
	@echo "$(BLUE)ðŸ“¦ å‡†å¤‡å‘å¸ƒåŒ…...$(RESET)"
	@if [ -d "$(DIST_DIR)" ]; then \
		echo "$(GREEN)ðŸ“š ç”Ÿæˆçš„ç”µå­ä¹¦æ–‡ä»¶:$(RESET)"; \
		ls -la $(DIST_DIR)/; \
		echo ""; \
		echo "$(GREEN)ðŸ“Š æ–‡ä»¶å¤§å°ç»Ÿè®¡:$(RESET)"; \
		du -h $(DIST_DIR)/*; \
	else \
		echo "$(RED)âŒ æ²¡æœ‰æ‰¾åˆ°ç”Ÿæˆçš„æ–‡ä»¶$(RESET)"; \
	fi

# æµ‹è¯•æž„å»º
test:
	@echo "$(BLUE)ðŸ§ª æµ‹è¯•æž„å»ºçŽ¯å¢ƒ...$(RESET)"
	@make check-deps
	@echo "$(GREEN)âœ… çŽ¯å¢ƒæµ‹è¯•é€šè¿‡$(RESET)"

# ç›‘æŽ§æ–‡ä»¶å˜åŒ–ï¼ˆéœ€è¦ fswatchï¼‰
watch:
	@echo "$(BLUE)ðŸ‘€ ç›‘æŽ§æ–‡ä»¶å˜åŒ–...$(RESET)"
	@command -v fswatch >/dev/null 2>&1 || { echo "$(RED)âŒ fswatch æœªå®‰è£…ï¼Œè¯·è¿è¡Œ: brew install fswatch$(RESET)"; exit 1; }
	fswatch -o $(PROJECT_ROOT)/chapters/ $(PROJECT_ROOT)/*.md | xargs -n1 -I{} make pdf

# ç»Ÿè®¡ä¿¡æ¯
stats:
	@echo "$(BLUE)ðŸ“Š é¡¹ç›®ç»Ÿè®¡ä¿¡æ¯$(RESET)"
	@echo "$(GREEN)ç« èŠ‚æ–‡ä»¶æ•°é‡:$(RESET) $$(find $(PROJECT_ROOT)/chapters -name "*.md" | wc -l)"
	@echo "$(GREEN)æ€»å­—æ•°ç»Ÿè®¡:$(RESET) $$(find $(PROJECT_ROOT) -name "*.md" -exec wc -w {} + | tail -1)"
	@echo "$(GREEN)å›¾ç‰‡æ–‡ä»¶æ•°é‡:$(RESET) $$(find $(PROJECT_ROOT)/images -type f | wc -l)"
	@if [ -d "$(DIST_DIR)" ]; then \
		echo "$(GREEN)ç”Ÿæˆçš„ç”µå­ä¹¦:$(RESET)"; \
		ls -1 $(DIST_DIR)/ 2>/dev/null || echo "  æ— "; \
	fi